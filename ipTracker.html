<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IP Tracker Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-100 p-8 font-sans">
  <h1 class="text-3xl font-bold mb-4">IP Tracker Tool</h1>
  <div class="flex flex-wrap gap-2 mb-4">
    <button id="fetch-ip" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded">Fetch IP</button>
  </div>
  <div id="warning" class="text-red-400 text-sm mb-4"></div>

  <div class="flex flex-wrap gap-2 mb-4">
    <input type="text" id="search" placeholder="Search IPs" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm w-52">
    <select id="sort" class="bg-gray-800 border border-gray-600 rounded px-4 py-2 text-sm">
      <option value="date">Sort by Date</option>
      <option value="alpha">Sort Alphabetically</option>
      <option value="duplicates">Duplicates First</option>
    </select>
  </div>

  <div id="ip-list" class="space-y-4 max-h-[70vh] overflow-y-auto"></div>

  <script>
    let ipList = JSON.parse(localStorage.getItem('ipList')) || [];
    let currentIP = null;

    async function fetchIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        currentIP = data.ip;

        const existing = ipList.find(ip => ip.address === currentIP);
        if (existing) {
          document.getElementById('warning').textContent = 'Duplicate IP address! Timestamp added.';
          existing.duplicates = existing.duplicates || [];
          existing.duplicates.push(new Date().toISOString());
        } else {
          document.getElementById('warning').textContent = '';
          const geoData = await fetch(`https://ipapi.co/${currentIP}/json/`).then(res => res.json());
          ipList.push({
            address: currentIP,
            note: '',
            date: new Date().toISOString(),
            location: `${geoData.city || 'Unknown'}, ${geoData.country_name || 'Unknown'}`,
            isp: geoData.org || 'N/A',
            duplicates: []
          });
        }

        localStorage.setItem('ipList', JSON.stringify(ipList));
        renderList();
      } catch (error) {
        document.getElementById('warning').textContent = 'Failed to fetch IP or location.';
      }
    }

    function renderList() {
      const search = document.getElementById('search').value.toLowerCase();
      const sort = document.getElementById('sort').value;
      const container = document.getElementById('ip-list');
      container.innerHTML = '';

      let list = ipList
        .filter(ip => ip.address.includes(search) || ip.note.toLowerCase().includes(search))
        .sort((a, b) => {
          if (sort === 'alpha') return a.address.localeCompare(b.address);
          if (sort === 'duplicates') return (b.duplicates?.length || 0) - (a.duplicates?.length || 0);
          return new Date(b.date) - new Date(a.date);
        });

      const fragment = document.createDocumentFragment();

      list.forEach((ip, index) => {
        const div = document.createElement('div');
        div.className = 'bg-gray-800 border border-gray-700 rounded p-4 shadow-sm';

        const duplicatesHTML = ip.duplicates.length
          ? `<div class="text-xs text-gray-400 mt-2">Duplicates:<ul class="list-disc ml-5">${ip.duplicates.map(d => `<li>${new Date(d).toLocaleString()}</li>`).join('')}</ul></div>`
          : '';
        const isCurrent = currentIP === ip.address ? `<div class="text-sm text-blue-400 mt-2">Current IP: ${currentIP}</div>` : '';

        div.innerHTML = `
          <div class="font-semibold text-green-400">${ip.address}</div>
          <div class="text-sm">Location: ${ip.location}</div>
          <div class="text-sm">ISP: ${ip.isp}</div>
          <div class="text-sm">Added on: ${new Date(ip.date).toLocaleString()}</div>
          ${duplicatesHTML}
          <input type="text" class="note-edit mt-2 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm w-full" value="${ip.note}" placeholder="Edit note">
          ${isCurrent}
          <button class="remove-btn mt-2 bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded">Remove</button>
        `;

        const noteInput = div.querySelector('.note-edit');
        const removeBtn = div.querySelector('.remove-btn');

        noteInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            ip.note = this.value;
            localStorage.setItem('ipList', JSON.stringify(ipList));
            this.blur();
          }
        });

        removeBtn.addEventListener('click', function () {
          ipList.splice(index, 1);
          localStorage.setItem('ipList', JSON.stringify(ipList));
          renderList();
        });

        fragment.appendChild(div);
      });

      container.appendChild(fragment);
    }

    document.getElementById('fetch-ip').addEventListener('click', fetchIP);
    document.getElementById('search').addEventListener('input', renderList);
    document.getElementById('sort').addEventListener('change', renderList);

    renderList();
  </script>
</body>
</html>
